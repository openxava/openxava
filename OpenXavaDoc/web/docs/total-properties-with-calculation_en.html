<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <title>Lesson 10: Total properties with Calculation - OpenXava</title>
    <link rel="stylesheet" href="static/style.css" type="text/css">
    <link rel="stylesheet" href="highlight/highlight.css">
    <script src="highlight/highlight.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </head>
  <body>
    <div class="wiki" id="content_view" style="display: block;">
      <h1 id="toc0"><a name="Lesson 5: Basic business logic"></a> <span id="breadcrumbs">
          <span id="openxava"> <a href="https://www.openxava.org/"> <span>o</span>pen<span>x</span>ava
              </a> </span> / <a href="index_en.html">documentation</a> / </span>
        Lesson 10: Total properties with Calculation </h1>
      <strong>Course</strong>: <a class="wiki_link" href="getting-started_en.html">1.
        Getting started</a> | <a class="wiki_link" href="basic-domain-model1_en.html">2.
        Basic domain model (1)</a> | <a class="wiki_link" href="basic-domain-model2_en.html">3.
        Basic domain model (2)</a> | <a class="wiki_link" href="refining-user-interface_en.html">4.
        Refining the user interface</a> | <a class="wiki_link" href="agile-development_en.html">5.
        Agile development</a> |&nbsp;<a class="wiki_link" href="mapped-superclass-inheritance_en.html">6.
        Mapped superclass inheritance</a> | <a class="wiki_link" href="entity-inheritance_en.html">7.
        Entity inheritance</a> | <a class="wiki_link" href="view-inheritance_en.html">8.
        View inheritance</a> | <a class="wiki_link" href="java-properties_en.html">9.
        Java properties</a> | <strong>10. Total properties with Calculation</strong>
      | <a class="wiki_link" href="total-properties-with-calculation_en.html">11.
        JPA retrocalling methods</a> | <a class="wiki_link" href="validation_en.html">12.
        Advanced validation</a> | <a class="wiki_link" href="refining-standard-behavior_en.html">13.
        Refining the standard behavior</a> | <a class="wiki_link" href="business-logic-behavior_en.html">14.
        Behavior &amp; business logic</a> | <a class="wiki_link" href="references-collections_en.html">15.
        References &amp; collections</a> | <a class="wiki_link" href="philosophy_en.html">A.
        Architecture &amp; philosophy</a> | <a class="wiki_link" href="jpa_en.html">B.
        Java Persistence API</a> | <a class="wiki_link" href="annotations_en.html">C.
        Annotations</a> | <a class="wiki_link" href="testing_en.html">D.
        Automated testing</a>
      <hr>
      <div id="toc">
        <h1 class="nopad">Table of contents</h1>
        <div style="margin-left: 1em;"><a href="#Lesson%205:%20Basic%20business%20logic">Lesson
10:
            Total properties with Calculation<br>
          </a></div>
        <div style="margin-left: 3em;"><a href="#Lesson%205:%20Basic%20business%20logic-Calculated%20properties-Persistent%20properties%20with%20Calculation">Persistent
            properties with @Calculation</a></div>
        <div style="margin-left: 3em;"><a href="#Lesson%205:%20Basic%20business%20logic-Calculated%20properties-Total%20properties%20of%20a%20collection">Total
            properties of a collection</a></div>
        <div style="margin-left: 3em;"><a href="#Lesson%205:%20Basic%20business%20logic-Calculated%20properties-Default%20value%20from%20a%20properties%20file">Default
            value from a properties file</a></div>
        <div style="margin-left: 3em;"><a href="#Lesson%205:%20Basic%20business%20logic-Calculated%20properties-Manual%20schema%20evolution">Manual
            schema evolution</a></div>
        <div style="margin-left: 2em;"><a href="#Lesson%205:%20Basic%20business%20logic-Summary">Summary</a></div>
      </div>
    </div>
    <div class="wiki" style="display: block;">We managed to add a calculated
      property to our application that allows us to add values to it, and we use
      @DefaultValueCalculator to store this value for each detail line. We will
      continue to improve our app in the following way:</div>
    <div class="wiki" style="display: block;">
      <h3><a name="Lesson 5: Basic business logic-Calculated properties-Persistent properties with Calculation"></a>Persistent
        properties with <i>@Calculation</i></h3>
      <i> </i>Sometimes calculated properties are not the best option. Imagine
      that you have a calculated property in <em>Invoice</em>, let's say <em>discount</em>:<br>
      <div class="wiki" style="display: block;">
        <pre><code class="java">// DON'T ADD TO YOUR CODE, IT'S JUST TO ILLUSTRATE
public BigDecimal getDiscount() {
    return getAmount().multiply(new BigDecimal("0.10"));
}
</code></pre> If you need to process all those invoices with an <i>discount</i>
        greater than 1000, you have to code something like the next code:<br>
        <pre><code class="java">// DON'T ADD TO YOUR CODE, IT'S JUST TO ILLUSTRATE
Query query = getManager().createQuery("from Invoice"); // No condition in query
for (Object o: query.getResultList()) { // Iterates over all objects
    Invoice i = (Invoice) o;
    if (i.getDiscount() // Queries every object
        .compareTo(new BigDecimal("1000")) &gt; 0) {
            i.doSomething();
    }
}
</code></pre> You cannot use a condition in the query to discriminate by <em>discount</em>,
        because <i>discount</i> is not in the database, it's only in the Java
        object, so you have to instantiate every object in order to ask by the <i>discount</i>.
        In some cases this way is a good option, but if you have a really huge
        amount of invoices, and only a few of them have the <i>discount</i>
        greater than 1000, then your process will be very inefficient. What
        alternative do we have?<br>
        Our alternative is to use the <em>@Calculation</em> annotation. <em>@Calculation</em>
        is an OpenXava annotation that allows to associate a simple calculation
        to a persistent property. You can define <em>discount</em> with <em>@Calculation</em>
        as shown the next code:<br>
        <pre><code class="java">// DON'T ADD TO YOUR CODE, IT'S JUST TO ILLUSTRATE
@ReadOnly
@Calculation("amount * 0.10")
BigDecimal discount;
</code></pre> This is a regular persistent property, that is with a
        corresponding column in the database, but it has a calculation defined
        with <i>@Calculation</i>. In this case the calculation is <i>amount *
          0.10</i>, so whenever the user changes <i>amount</i> in the user
        interface <i>discount</i> will be recalculated instantly. The
        recalculated value will be saved in the database when user clicks on <i>Save</i>,
        just like in any persistent property. We also have annotated <i>discount</i>
        with <i>@ReadOnly</i>, so it looks and behaves like a calculated
        property, although you can omit <i>@ReadOnly</i> so the user could
        modify the calculated value.</div>
      <div class="wiki" style="display: block;"> The most useful thing of <em>@Calculation</em>
        properties is that you can use it in conditions, so that you can rewrite
        the above process as shown in the next code:<br>
        <pre><code class="java">// DON'T ADD TO YOUR CODE, IT'S JUST TO ILLUSTRATE
Query query = getManager().createQuery("from Invoice i where i.discount &gt; :discount"); // Condition allowed
query.setParameter("discount", new BigDecimal(1000));
for (Object o: query.getResultList()) { // Iterates only over selected objects
    Invoice i = (Invoice) o;
    i.doSomething();
}
</code></pre> In this way we put the weight of selecting the records on the
        database server, and not on the Java server. Moreover, the discounts are
        not recalculated each time, they are already calculated and saved.<br>
        This fact also has effect in the list mode, because the user cannot
        filter or order by calculated properties, but he can do so using
        persistent properties with <em>@Calculation</em>:<br>
        <img src="files/business-logic_en025.png" alt="business-logic_en025.png"
          title="business-logic_en025.png"><br>
        <em>@Calculation</em> is a good option when you need filtering and
        sorting, and a simple calculation is enough. A shortcoming of <i>@Calculation</i>
        properties is that their values are recalculated only when the user
        interact with the record and changes some value of the properties used
        in the calculation, therefore when you add a new <i>@Calculation</i>
        property to an entity with existing data you have to update the values
        of the new column in the table using SQL. On the other hand if you need
        a complex calculation, with loops or consulting other entities, you
        still need a calculated property with your Java logic in the getter. In
        this last case if you need to sort and filter in list mode for the
        calculated property an option is to have both, the calculated and the
        persistent property, and synchronize their values using JPA callback
        methods (we'll talk about callback methods below). </div>
    </div>
    <div class="wiki" style="display: block;">
      <h3 id="toc4"><a name="Lesson 5: Basic business logic-Calculated properties-Total properties of a collection"></a>Total
        properties of a collection</h3>
    </div>
    <div class="wiki" style="display: block;">We want to add amounts to <em>Order</em>
      and <em>Invoice</em> too. To calculate vat, base amount and total amount
      are indispensable. To do so you only need to add a few properties to <em>CommercialDocument</em>
      class. The next figure shows the user interface for these properties: </div>
    <div class="wiki" style="display: block;"> <img src="files/business-logic_en030.png"
        alt="business-logic_en030.png" title="business-logic_en030.png"><br>
      Add the next code to <i>CommercialDocument</i> entity:<br>
      <pre><code class="java">@Digits(integer=2, fraction=0) // To indicate its size
BigDecimal vatPercentage;
   
@ReadOnly
@Stereotype("MONEY")
@Calculation("sum(details.amount) * vatPercentage / 100")
BigDecimal vat;

@ReadOnly
@Stereotype("MONEY")
@Calculation("sum(details.amount) + vat")    
BigDecimal totalAmount;    
</code></pre></div>
    <div class="wiki" style="display: block;">Note how we have chosen <i>@Calculation
        + @ReadOnly</i> persistent properties over calculated ones for <i>vat</i>
      and <i>totalAmount</i>, because the calculations are simple, and
      filtering and ordering for them is very useful. Also, you can see how in <i>@Calculation</i>
      you can use <i>sum(details.amount)</i> to refer to the sum of the column
      <i>amount</i> of the collection <i>details</i>, in this way we don't need
      to have a <i>baseAmount</i> property. On the other hand, <em>vatPercentage</em>
      is a conventional persistent property. In this case we use <em>@Digits</em>
      (an annotation from Bean Validation, the validation standard of Java) as
      an alternative to <em>@Column</em> to specify its size.</div>
    <div class="wiki" style="display: block;"> Now that you have written the
      amount properties of <em>CommercialDocument</em>, you must modify the
      list of properties of the collection to show <a class="wiki_link" href="view_en.html#View-Collection%20customization-Total%20properties%20%28new%20in%20v4.3%29">the
        total properties</a> of the <em>CommercialDocument</em> (<em>Invoice</em>
      and <em>Order).</em> Let's see it:<br>
      <pre><code class="java">abstract public class CommercialDocument extends Identifiable {
 
    @ElementCollection
    @ListProperties(
        "product.number, product.description, quantity, pricePerUnit, " +
        "amount+[" + 
        	"commercialDocument.vatPercentage," +
        	"commercialDocument.vat," +
        	"commercialDocument.totalAmount" +
        "]" 
    )
    private Collection&lt;Detail&gt; details;
 
    ...
}
</code></pre>Total properties are regular properties of the entity (<i>CommercialDocument</i>
      in this case) that are placed in the user interface below the column of a
      collection. For that, in <i>@ListProperties</i> you use square brackets
      after the property to enumerate them, like <i>amount[commercialDocument.totalAmount]</i>.
      Moreover, if you want just the summation of the column you don't need a
      property for that, with a + after the property in <i>@ListProperties</i>
      is enough, like <i>amount+</i>. In our case we combine both things, + and
      total properties between [ ]. </div>
    <div class="wiki" style="display: block;">Now you can try your application.
      It would behave almost as in figure at the begin of this section. “Almost”
      because <i>vatPercentage</i> does not have a default value yet. We add it
      in the next section.<br>
      <h3 id="toc5"><a name="Lesson 5: Basic business logic-Calculated properties-Default value from a properties file"></a>Default
        value from a properties file</h3>
      It's useful for the user to have the default value populated for the <em>vatPercentage</em>.
      You could use calculator (with <em>@DefaultValueCalculator</em>) that
      returns a fixed value, but in that case changing the default value means
      changing your source code. Otherwise you could read the default value from
      the database (using JPA from your calculator), but in that case changing
      the default value means updating a database table.<br>
      Another option is to store this configuration value in a properties file,
      a plain file with key=value pairs. In this case changing the default value
      for <em>vatPercentage</em> is just a matter of editing a plain file with
      a text editor.<br>
      Let's implement the properties file option. Create a file named <em>invoicing.properties</em>
      in the <em>Invoicing/properties</em> folder with the next content:<br>
      <pre><code class="properties">defaultVatPercentage=21
</code></pre> Though you can use the <em>java.util.Properties</em> class from
      Java to read this file we prefer to create a custom class to read these
      properties. We are going to call this class <em>InvoicingPreferences</em>
      and we'll put it in a new package named <em>com.yourcompany.invoicing.util</em>.
      You have the code here:<br>
      <pre><code class="java">package com.yourcompany.invoicing.util; // in 'util' package

import java.io.*;
import java.math.*;
import java.util.*;
 
import org.apache.commons.logging.*;
import org.openxava.util.*;
 
public class InvoicingPreferences {
 
    private final static String FILE_PROPERTIES="invoicing.properties";
    private static Log log = LogFactory.getLog(InvoicingPreferences.class);
    private static Properties properties; // We store the properties here
 
    private static Properties getProperties() {
        if (properties == null) { // We use lazy initialization
            PropertiesReader reader = // PropertiesReader is a utility class from OpenXava
                new PropertiesReader( InvoicingPreferences.class, FILE_PROPERTIES);
            try {
                properties = reader.get();
            }
            catch (IOException ex) {
                log.error( XavaResources.getString( // To read a i18n message
                    "properties_file_error", FILE_PROPERTIES), ex);
                properties = new Properties();
            }
        }
        return properties;
    }
 
    public static BigDecimal getDefaultVatPercentage() { // The only public method
        return new BigDecimal(getProperties().getProperty("defaultVatPercentage"));
    }
}
</code></pre> As you can see <em>InvoicingPreferences</em> is a class with one
      static method, <em>getDefaultVatPercentage()</em>. The advantage of using
      this utility class over reading directly the properties file is that if
      you change the way the preferences are obtained, for example reading from
      a database or an LDAP directory, you only have to change this class in
      your entire application.<br>
      You can use this class from the default calculator for the <em>vatPercentage</em>
      property. See the calculator in the next code:<br>
      <pre><code class="java">package com.yourcompany.invoicing.calculators; // In 'calculators' package

import org.openxava.calculators.*; // To use ICalculator
import com.yourcompany.invoicing.util.*; // To use InvoicingPreferences
 
public class VatPercentageCalculator implements ICalculator {
 
    public Object calculate() throws Exception {
        return InvoicingPreferences.getDefaultVatPercentage();
    }
}
</code></pre> As you see, it just returns the <em>defaultVatPercentage</em>
      from <em>InvoicingPreferences</em>. Now, you can use this calculator in
      the definition of <em>vatPercentage</em> property in <em>CommercialDocument</em>:<br>
      <pre><code class="java">@DefaultValueCalculator(VatPercentageCalculator.class)
BigDecimal vatPercentage;
</code></pre> With this code when the user clicks to create a new invoice, the <em>vatPercentage</em>
      field will be filled with 21 or whatever other value you put in <em>invoicing.properties</em>.</div>
    <div class="wiki" style="display: block;">
      <h3><a name="Lesson 5: Basic business logic-Calculated properties-Manual schema evolution"></a>Manual
        schema evolution</h3>
      When you use things like <i>@Calculation</i> or <i>@DefaultValueCalculator</i>
      the automatic evolution schema provides by OpenXava falls short, because
      it adds a new column when you add a new property, but it does not fill the
      column with the correct values. In this case we have added several
      persistent properties with <i>@Calculation</i> whose values are not
      recalculated until the user interact with the record. Moreover, we have a
      default value for <i>vatPercentage</i> that only has effect when the user
      creates a new record but not on the existing records. We have to fill the
      new columns with reasonable values.</div>
    <div class="wiki" style="display: block;">Given that we're in early
      development stage just removing all the records would be a good enough
      solution, but for sure that is not a good idea in production, so we're
      going to adjust our database to new code without lose data to illustrate
      manual evolution schema.</div>
    <div class="wiki" style="display: block;">The easier way is to use the
      application itself to do the updates. We're going to do it for updating
      the product prices. In order our new calculated properties work nicely all
      the products should have price, so go to the <i>Product</i> module with
      your browser and make sure that all products have price:</div>
    <img src="files/business-logic_en040.png" alt="business-logic_en040.png" title="business-logic_en040.png">
    <div class="wiki" style="display: block;">If some product has no price edit
      it and enter a price.</div>
    <div class="wiki" style="display: block;">The next changes are not so
      simple, therefore we're going to execute SQL statements against our
      database. To execute these SQL statements, first make sure your
      application is running, then use the menu option <i>OpenXava &gt;
        Database Manager</i> of OpenXava Studio:<br>
      <img src="files/inheritance040.png" alt="inheritance040.png" title="inheritance040.png"><br>
      Now you are ready to write and execute SQLs.First, we set value for <i>pricePerUnit</i>
      column in all details: </div>
    <div class="wiki" style="display: block;">
      <pre><code class="sql">UPDATE INVOICING.COMMERCIALDOCUMENT_DETAILS 
SET PRICEPERUNIT = (
    SELECT PRICE FROM INVOICING.PRODUCT 
    WHERE NUMBER = PRODUCT_NUMBER
)
</code></pre> </div>
    <div class="wiki" style="display: block;">Then we update the <i>vatPercentage</i>
      for all invoices:</div>
    <div class="wiki" style="display: block;">
      <pre><code class="sql">UPDATE INVOICING.COMMERCIALDOCUMENT
SET VATPERCENTAGE = 21
</code></pre> </div>
    <div class="wiki" style="display: block;">Next, the updating of <i>vat</i>:</div>
    <div class="wiki" style="display: block;">
      <pre><code class="sql">UPDATE INVOICING.COMMERCIALDOCUMENT
SET VAT = (
    SELECT SUM(PRICEPERUNIT * QUANTITY) * 0.21 
    FROM INVOICING.COMMERCIALDOCUMENT_DETAILS D 
    WHERE D.COMMERCIALDOCUMENT_OID = COMMERCIALDOCUMENT.OID
)
</code></pre> </div>
    <div class="wiki" style="display: block;">Finally, we update the <i>totalAmount</i>
      of all invoices:</div>
    <div class="wiki" style="display: block;">
      <pre><code class="sql">UPDATE INVOICING.COMMERCIALDOCUMENT
SET TOTALAMOUNT = (
    SELECT SUM(PRICEPERUNIT * QUANTITY) * 1.21 
    FROM INVOICING.COMMERCIALDOCUMENT_DETAILS D 
    WHERE D.COMMERCIALDOCUMENT_OID = COMMERCIALDOCUMENT.OID
)
</code></pre> </div>
    <div class="wiki" style="display: block;">Beware, the above sentences work
      nicely with HSQLDB, the database included with OpenXava. If you're using
      another database probably you have to adapt the syntax. After executing
      the above sentences you can try your application. It would behave as in
      figure at the begin of the section "Total properties of a collection" even
      for already existing invoices and orders.<br>
    </div>
    <br>
    <div class="wiki" style="display: block;">
      <h2 id="toc14"><a name="Lesson 5: Basic business logic-Summary"></a>Summary</h2>
      In this lesson, you have learned how to use the @Calculation annotation to
      associate a simple calculation with a persistent property, greatly
      improving query efficiency and response speed, and allowing us to add
      different functionality to total, such as VAT calculation. We also learned
      how to add default values, and how to manually modify our database schema.
      In the next lesson, we'll review different JPA callback methods,
      synchronizing persistent and computed properties, and using the @Formula
      annotation.<br>
      <br>
      <strong>Any problem with this lesson? <a class="wiki_link_ext" href="http://sourceforge.net/p/openxava/discussion/419690/"
          rel="nofollow">Ask in the forum</a></strong> <strong>Everything fine?
        <a class="wiki_link" href="jpa-retrocalling-methods_en.html">Go to
          Lesson 11</a></strong> </div>
  </body>
</html>
